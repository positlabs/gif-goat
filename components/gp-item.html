<!-- 

	TODO 

	- no transparency pixel on gifs
	- paletteuse adds ~3x file size. why?

-->

<link rel='import' href='./gp-thumbnail.html'>
<link rel='import' href='./gp-progress-bar.html'>

<dom-module id='gp-item'>

	<style>

		:host {
			display: block;
			position: relative;
			width: 100%; height: 50px;
			margin: 10px 0;
			cursor: default;
			overflow: hidden;
			color: white;
		}

		#thumb, #progress, #filename {
			float: left;
		}

		#thumb {
			margin-left: 20px;
		}

		#filename {
			margin-left: 20px;
			line-height: 50px;
			font-size: .8em;
		}

		#progressBar {
			position: absolute;
			top: 40px; left: 90px;
			width: -webkit-calc(100% - 150px)
		}

		.btns {
			position: absolute;
			right: 20px; top: 50%;
			transform: translateY(-50%);
			width: 100px;
		}
		.btns .btn {
			display: inline-block;
			float: right;
			padding: 5px;
		}

		.btn:hover {
			color: var(--light-green);
		}

		#open-btn, #preview-btn {
			display: none;
		}

	</style>
	
	<template>

		<gp-thumbnail id='thumb' title='[[state]]'></gp-thumbnail>
		<div id='filename' title='[[file.path]]'>[[file.path]]</div>
		<gp-progress-bar id='progressBar'></gp-progress-bar>
		<div id='progress' hidden></div>

		<div class='btns'>
			<div id='open-btn' class='btn fa fa-external-link-square' on-click='_open' title='show in folder'></div>
			<div id='preview-btn' class='btn fa fa-eye' on-click='_preview' title='preview'></div>
			<div id='remove-btn' class='btn fa fa-close' on-click='_remove' title='remove'></div>
		</div>


	</template>

	<script>(function(){

		const fs = require('fs');
		const path = require('path');
		const paths = require('./modules/paths');
		const shell = require('electron').shell;
		const remote = require('electron').remote;
		const argv = require('yargs').argv;
		const ffmpeg = require('fluent-ffmpeg');
		const ffmpegPath = require('./modules/ffmpeg-static').ffmpeg;
		const ffprobePath = require('./modules/ffmpeg-static').ffprobe;
		ffmpeg.setFfmpegPath(ffmpegPath);
		ffmpeg.setFfprobePath(ffprobePath);
		console.log(ffmpegPath);

		var states = {
			ready: 'ready',
			processing: 'processing',
			done: 'done',
		};
		
		Polymer({
			is: 'gp-item',

			properties: {
				file: {
					type: Object,
					observer: '_onFileChanged'
				},
				state: {
					type: String,
					readOnly: true,
					value: states.ready,
					notify: true,
					observer: '_onStateChanged'
				},
				progress: {
					type: Number,
					value: 0,
					readOnly: true
				}
			},

			_onStateChanged(){
				switch(this.state){

					case states.ready:
						this.$.progressBar.show();

						break;

					case states.processing:
						// show progress bar
						this.$.thumb.processing();
						document.title = 'GIFFLY | processing...';

						break;

					case states.done:
						this.$.thumb.done();
						this.$.progressBar.hide();

						// hide close button
						this.$['remove-btn'].style.display = 'none';

						// show folder button
						this.$['open-btn'].style.display = 'block';
						this.$['preview-btn'].style.display = 'block';

						// show preview button

						// show gif name
						this.$.filename.innerHTML = path.parse(this.file.path).name + '.gif';
						
						document.title = 'GIFFLY | done!';

						break;

				}
			},

			_onFileChanged(){
				console.log(this.localName, '_onFileChanged');
				this.$.filename.innerHTML = path.basename(this.file.path);
				this.$.thumb.video = this.file.path;
			},

			_generatePalette(){
				var settings = this._settings;

				// console.log(size);
				
				return new Promise( (resolve, reject) => {
					this.paletteCommand = ffmpeg(this.file.path)
						.on('start', commandLine => {
							// console.log('Spawned Ffmpeg with command: ' + commandLine);
						})
						.videoFilters([
							'palettegen'
						])
						.on('error', e => {
							console.log(e);
							reject(e);
						})
						.on('end', () => {
							resolve();
						});

						if(settings.fps){
							this.paletteCommand.fps(settings.fps);
						}

						// FIXME: downsize the input so we don't need to spend as much time generating the palette
						// probably need to use -vf with size filters included

						// var w = (settings.width.length && settings.width > 0) ? settings.width : '?',
						// 	h = (settings.height.length && settings.height > 0) ? settings.height : '?';
						// if(w+h !== '??'){
						// 	this.paletteCommand.size([w, h].join('x'));
						// }

						this.paletteCommand.save( this._getPalettePath(this.file.path) );

					// console.log(this.paletteCommand);

				}).catch( err => { console.log(err); } );
			},

			_getPalettePath(filepath){
				return path.join(paths.temp, 'palette_' + path.parse(filepath).name + '.png');
			},
			_getGIFPath(filepath){
				// console.log('_getGIFPath', this, filepath);
				return path.join(this._settings.output, path.parse(filepath).name + '.gif');
			},

			_encodeGIF(){
				var settings = this._settings;

				return new Promise( (resolve, reject) => {

					var w = (settings.width.length && settings.width > 0) ? settings.width : '-1',
						h = (settings.height.length && settings.height > 0) ? settings.height : '-1';
					var scaleFilter = 'scale=' + [w, h, 'flags=lanczos'].join(':') + ',';
					if(w+h === '-1-1') scaleFilter = '';
					console.log('-lavfi ' + scaleFilter + 'paletteuse');

					this.ffmpegCommand = ffmpeg()
						.input(this.file.path)
						.input(this._getPalettePath(this.file.path))
						.outputOptions([
							'-lavfi ' + scaleFilter + 'paletteuse'
						])
						.on('start', commandLine => {
							// console.log('Spawned Ffmpeg with command: ' + commandLine);
						})
						.on('progress', progress => {
							console.log('progress', progress.percent);
							this._setProgress(progress.percent);
							this.$.progress.innerHTML = Math.round(progress.percent) + '%';
							this.$.progressBar.progress = progress.percent;
						})
						.on('error', (err, stdout, stderr) => {
							console.log('Cannot process video: ' + err.message);
							//TODO: display error message in parent
							reject(err.message);
						})
						.on('end', () => {
							console.log('Transcoding succeeded!');
							this._setProgress(100);
							this.$.progress.innerHTML = '100%';
							this.$.progressBar.progress = 100;
							this._setState('done');
							resolve();
						})

						if(settings.fps){
							this.ffmpegCommand.fps(settings.fps);
						}

						this.ffmpegCommand.save( this._getGIFPath(this.file.path) );
				});
			},

			run(settings){

				// only run the encoding process once
				if(this.runPromise !== undefined) return this.runPromise;
				
				this._settings = settings;
				
				this._setState('processing');

				this.runPromise = new Promise((resolve, reject) => {
					this._generatePalette()
						.then(() => {
							this._encodeGIF().then(()=>{
								resolve();
							});
						});
				});

				return this.runPromise;
			},

			_open(){
				// console.log('_open', this);
				shell.showItemInFolder( this._getGIFPath(this.file.path) );
			},

			_remove(){

				if(this.paletteCommand){
					this.paletteCommand.kill([signal='SIGKILL']);
				}
				if(this.ffmpegCommand){
					this.ffmpegCommand.kill([signal='SIGKILL']);
				}

				TweenMax.to(this, .3, {height: 0, ease: Power3.easeOut, onComplete: ()=>{
					this.remove();
				}});
			},

			_preview(){

				var img = document.createElement('img');
				img.addEventListener('load', e => {

					ipc.send('open-preview', {
						width: img.width, 
						height: img.height,
						gif: this._getGIFPath(this.file.path)
					});
				});

				img.src = 'file://' + this._getGIFPath(this.file.path);
			},

			detached(){
				this.fire('detached');
			}

		});

	})();</script>

</dom-module>