<link rel='import' href='../bower_components/Polymer/polymer.html'>
<!-- <link rel='import' href='../bower_components/iron-icons/iron-icons.html'> -->

<link rel='import' href='./gp-menu-bar.html'>
<link rel='import' href='./gp-droptarget.html'>
<link rel='import' href='./gp-item.html'>
<link rel='import' href='./gp-settings.html'>

<link rel='stylesheet' href='global.css'>

<!-- 

	TODO
		copy/paste file support

-->

<dom-module id="gp-app">

	<style>
		:host {
			position: absolute;
			width: 100%; height: 100%;
			top: 0; left: 0;
		}
		#queue {
			margin-top: 60px;
		}
		.btn {
			cursor: pointer;
		}
	</style>
	
	<template>

		<gp-menu-bar></gp-menu-bar>
		
		<div id="queue"></div>

		<gp-droptarget id='dropTarget' on-files-changed='_onFilesDropped'></gp-droptarget>
		<div class='btn' on-click='_onClickSelectVideos'>Select videos</div>
		<input id='fileSelector' type='file' multiple hidden>
		
		<gp-settings id='settings'></gp-settings>
		
		<div class='btn' on-click='_start'>start encoding</div>

	</template>

	<script>(function(){
		
		Polymer({
			is: "gp-app",

			properties: {
				state: {
					type: String,
					value: 'stopped',
					readOnly: true,
					observer: '_onStateChanged'
				}
			},

			ready: function(){
				this.$.fileSelector.addEventListener('change', this._onFileSelectorChanged.bind(this));
			},

			_onStateChanged: function(){
				// TODO:
				switch(this.state){
					case 'stopped': 
						break;
					case 'running': 
						break;
				}
			},

			_onClickSelectVideos: function(e){
				this.$.fileSelector.click();
			},

			_onFileSelectorChanged: function(e){
				console.log(e);
				var files = Array.prototype.slice.apply(e.target.files);
				this._handleNewFiles(files);
			},

			_onFilesDropped: function(e){
				console.log(this.localName, '_onFilesDropped', e);
				var files = Array.prototype.slice.apply(e.detail.value);
				this._handleNewFiles(files);
			},

			_handleNewFiles: function(files){
				var currentFilePaths = this._getFilePathsInQueue();
				files.forEach(function(file){
					// don't add files that are already in the queue
					if(currentFilePaths.indexOf(file.path) !== -1) return;
					//TODO: if queue is running, run the gp-item...?
					var itemEl = document.createElement('gp-item');
					itemEl.file = file;
					this.$.queue.appendChild(itemEl);
				}.bind(this));
			},

			_getFilePathsInQueue: function(){
				var items = Array.prototype.slice.apply(this.$.queue.querySelectorAll('gp-item'));
				return items.map(function(item){ return item.file.path; });
			},

			_start: function(){
				// console.log('gp-app._start');
				
				this._setState('running');

				// collect promises so we can set state
				var items = Array.prototype.slice.apply(this.$.queue.querySelectorAll('gp-item'));
				var settings = this.$.settings.get();
				var promises = items.map(function(item){
					return item.run(settings);
				});
				Promise.all(promises).then(function(){
					console.log('encoding promises resolved!');
					this._setState('stopped');
				}.bind(this));
			},

		});

	})();</script>

</dom-module>